//let BASE_URL="https://logify.tabgraf.com";function serializeFormToJSON(form){const formData=new FormData(form);const jsonObject={};formData.forEach((value,key)=>{if(jsonObject[key]){if(Array.isArray(jsonObject[key])){jsonObject[key].push(value)}else{jsonObject[key]=[jsonObject[key],value]}}else{jsonObject[key]=value}});return jsonObject}function isValidHttpsUrl(string){try{const url=new URL(string);return url.protocol==="https:"}catch(_){return false}}function getShopDomain(){let scripts=document?.querySelectorAll("script");let shopDomain="";scripts?.forEach(script=>{if(isValidHttpsUrl(script?.src)&&new URL(script?.src)?.searchParams?.get("shop")){shopDomain=new URL(script?.src)?.searchParams.get("shop")}});return shopDomain}function addOrUpadateEventsInLocalStorage(eventPayload,eventType){let eventsArrayFromLocalstorage=localStorage.getItem("eventsArray");if(eventsArrayFromLocalstorage){eventsArrayFromLocalstorage=JSON.parse(eventsArrayFromLocalstorage);let event={eventPayload:eventPayload,eventType:eventType,timestamp:(new Date).getTime()};if(eventType=="login"){if(!eventsArrayFromLocalstorage.find(elem=>elem?.eventType=="login")){eventsArrayFromLocalstorage.push(event);localStorage.setItem("eventsArray",JSON.stringify(eventsArrayFromLocalstorage))}}else{eventsArrayFromLocalstorage.push(event);localStorage.setItem("eventsArray",JSON.stringify(eventsArrayFromLocalstorage))}}else{localStorage.setItem("eventsArray",JSON.stringify([{eventType:eventType,eventPayload:eventPayload,timestamp:(new Date).getTime()}]))}}function getBrowserAndOS(){const userAgent=window.navigator.userAgent;const platform=window.navigator.platform;let os="Unknown OS";let browser="Unknown Browser";if(platform.indexOf("Win")!==-1)os="Windows";else if(platform.indexOf("Mac")!==-1)os="MacOS";else if(platform.indexOf("Linux")!==-1)os="Linux";else if(/Android/.test(userAgent))os="Android";else if(/iPhone|iPad|iPod/.test(userAgent))os="iOS";if(userAgent.indexOf("Chrome")>-1)browser="Chrome";else if(userAgent.indexOf("Safari")>-1&&userAgent.indexOf("Chrome")===-1)browser="Safari";else if(userAgent.indexOf("Firefox")>-1)browser="Firefox";else if(userAgent.indexOf("MSIE")>-1||!!document.documentMode)browser="Internet Explorer";else if(userAgent.indexOf("Edge")>-1)browser="Edge";return{os:os,browser:browser}}function getDeviceType(){const ua=navigator.userAgent;if(/Mobile|Android|iP(ad|hone)/.test(ua)){return"Mobile"}else if(/Tablet|iPad/.test(ua)){return"Tablet"}else{return"Desktop"}}async function getVisitorInfo(){const{os,browser}=getBrowserAndOS();const deviceType=getDeviceType();return{os:os,browser:browser,deviceType:deviceType}}function handleLoginFormSubmit(form){form.addEventListener("submit",event=>{let formData=serializeFormToJSON(event.target);let email=null;let name=null;let shopDomain=getShopDomain();Object.keys(formData).forEach(key=>{if(key?.includes("email")){email=formData[key]}if(key?.includes("name")){name=formData[key]}});if(email){let loginEvent={email:email,name:name,shopDomain:shopDomain};addOrUpadateEventsInLocalStorage(loginEvent,"login")}})}function trackLoginAndRegisterFormSubmit(){try{let loginForm=null;document?.querySelectorAll("form")?.forEach(form=>{if(form?.action?.includes("/login")||form?.action?.includes("/register")||form?.id?.includes("create")||form?.id?.includes("login")){loginForm=form}});if(loginForm){handleLoginFormSubmit(loginForm)}}catch(error){}}function trackButtonSubmit(){let loginForm=null;document?.querySelectorAll?.("button, input")?.forEach(button=>{if(button?.type?.includes("submit")){loginForm=button.closest("form")}});if(loginForm){handleLoginFormSubmit(loginForm)}}function trackInputSubmit(){let loginForm=null;document?.querySelectorAll?.("input")?.forEach(input=>{if(input?.value?.includes("login")||input?.value?.includes("create")){loginForm=input.closest("form")}});if(loginForm){handleLoginFormSubmit(loginForm)}}function trackUrlChange(){let currentUrl=window.location.href;let referrer=document.referrer;let visitorId=localStorage.getItem("visitorId");let visitorSessionId=localStorage.getItem("visitorSessionId");if(visitorId&&visitorSessionId){let urlEvent={currentUrl:currentUrl,referrer:referrer,title:document?.title??""};if(currentUrl?.includes("/products")){let img=document?.querySelectorAll("#main-content img, main img")[0];urlEvent.urlType="product";urlEvent.imgUrl=img?.getAttribute("src");addOrUpadateEventsInLocalStorage(urlEvent,"url-change")}else{addOrUpadateEventsInLocalStorage(urlEvent,"url-change")}}trackVisitorLoginStatus(referrer)}async function trackCart(){let lastCartTrackedTime=localStorage.getItem("lastCartTrackedTime");if(!lastCartTrackedTime||(new Date).getTime()-Number(lastCartTrackedTime)>=15*1e3){try{let shopDomain=`${window.location.protocol}//${window.location.host}`;let response=await fetch(`${shopDomain}/cart.js`,{method:"GET"});response=await response.json();if(response?.items?.length>0){let encryptedCart=btoa(JSON.stringify(response));let cartFromLocalStorage=localStorage.getItem("visitorCart");if(encryptedCart!=cartFromLocalStorage){let cartEvent={cartItems:response?.items?.map(item=>{return{url:item?.url,image:item?.image,quantity:item?.quantity}})};addOrUpadateEventsInLocalStorage(cartEvent,"cart-update")}}localStorage.setItem("lastCartTrackedTime",(new Date).getTime());localStorage.setItem("visitorCart",encryptedCart)}catch(error){}}}async function createSession(visitorId,shopDomain){let visitorLastActivityTime=localStorage.getItem("visitorLastActivityTime");if(!visitorLastActivityTime||(new Date).getTime()-Number(visitorLastActivityTime)>=30*60*1e3){localStorage.setItem("visitorLastActivityTime",(new Date).getTime());let visitorInfo=await getVisitorInfo();let sessionResponse=await fetch(`${BASE_URL}/api/storefront/visitors/session/create`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({visitorId:visitorId,shopDomain:shopDomain,startTime:(new Date).getTime(),deviceType:visitorInfo?.deviceType,os:visitorInfo?.os,browser:visitorInfo?.browser,returningUser:window?.logifyVisitorType})});sessionResponse=await sessionResponse.json();if(sessionResponse.status=="success"){localStorage.setItem("visitorSessionId",sessionResponse.data)}}}async function trackVisitorLoginStatus(prevUrl){if(prevUrl?.includes("account/login")||prevUrl?.includes("account/register")){let visitorInfo=document?.querySelector("script#web-pixels-manager-setup")?.innerHTML;let customer=visitorInfo?.split("customer")[1];let shopDomain=getShopDomain();if(customer?.includes("email")){let email=customer?.split('email":"')[1]?.split('"')[0];let loginEvent={email:email,shopDomain:shopDomain};addOrUpadateEventsInLocalStorage(loginEvent,"login")}}}async function createVisitor(visitorId,shopDomain){let visitorResponse=await fetch(`${BASE_URL}/api/storefront/visitors/create`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({visitorId:visitorId,shopDomain:shopDomain})});visitorResponse=await visitorResponse.json();if(visitorResponse.status=="success"){localStorage.setItem("visitorId",visitorId)}createSession(visitorId,shopDomain)}async function updateVisitor(prevVisitorId,email,shopDomain){let visitorResponse=await fetch(`${BASE_URL}/api/storefront/visitors/${prevVisitorId}/update`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({shopDomain:shopDomain,email:email})});visitorResponse=await visitorResponse.json();if(visitorResponse.status=="success"){localStorage.setItem("visitorId",email)}let sessionResponse=await fetch(`${BASE_URL}/api/storefront/visitors/session/update`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({prevVisitorId:prevVisitorId,email:email,shopDomain:shopDomain})});sessionResponse=await sessionResponse.json();createSession(email,shopDomain)}function trackVisitor(){let visitorId=localStorage.getItem("visitorId");if(!visitorId){let visitorInfo=document?.querySelector("script#web-pixels-manager-setup")?.innerHTML;let customer=visitorInfo?.split("customer")[1];let shopDomain=getShopDomain();window.logifyVisitorType=false;if(customer?.includes("email")){let email=customer?.split('email":"')[1]?.split('"')[0];createVisitor(email,shopDomain)}else{let tempVisitorId=crypto.randomUUID();createVisitor(tempVisitorId,shopDomain)}}else{let visitorInfo=document?.querySelector("script#web-pixels-manager-setup")?.innerHTML;let customer=visitorInfo?.split("customer")[1];let shopDomain=getShopDomain();window.logifyVisitorType=true;if(customer?.includes("email")){let email=customer?.split('email":"')[1]?.split('"')[0];updateVisitor(visitorId,email,shopDomain)}}}function trackButtonClicks(){document.querySelectorAll("button").forEach(button=>{button.addEventListener("click",event=>{let eventPayload={text:event.target.innerText,url:window.location.href};addOrUpadateEventsInLocalStorage(eventPayload,"button-click")})})}trackUrlChange();trackCart();trackVisitor();trackButtonSubmit();trackInputSubmit();trackLoginAndRegisterFormSubmit();trackButtonClicks();function sleep(ms){return new Promise(resolve=>{setTimeout(()=>{resolve("Awake")},ms)})}function syncEventsToDb(){let events=localStorage.getItem("eventsArray");if(events){let visitorId=localStorage.getItem("visitorId");let visitorSessionId=localStorage.getItem("visitorSessionId");events=JSON.parse(events);fetch(`${BASE_URL}/api/storefront/visitors/events/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:events,visitorId:visitorId,sessionId:visitorSessionId,shopDomain:getShopDomain()})});localStorage.removeItem("eventsArray")}}setInterval(()=>{syncEventsToDb()},5e3);function createNewVisitorSession(){let visitorIdFromLocal=localStorage.getItem("visitorId");if(visitorIdFromLocal){createSession(visitorIdFromLocal,getShopDomain())}}document.querySelectorAll("form").forEach(elem=>{elem.addEventListener("submit",event=>{let actionUrl=event.target.action;if(actionUrl?.includes("/search")){let inputValue=elem?.querySelector("input")?.value;addOrUpadateEventsInLocalStorage({searchQuery:inputValue},"search")}else{addOrUpadateEventsInLocalStorage({actionUrl:event.target.action},"form-submit")}})});window.addEventListener("keypress",()=>{createNewVisitorSession()});document.body.addEventListener("click",()=>{createNewVisitorSession();trackCart()});
