let BASE_URL="https://logify-message-bus.tabgraf.com";function serializeFormToJSON(form){const formData=new FormData(form);const jsonObject={};formData.forEach((value,key)=>{if(jsonObject[key]){if(Array.isArray(jsonObject[key])){jsonObject[key].push(value)}else{jsonObject[key]=[jsonObject[key],value]}}else{jsonObject[key]=value}});return jsonObject}function isValidHttpsUrl(string){try{const url=new URL(string);return url.protocol==="https:"}catch(_){return false}}function getShopDomain(){let scripts=document?.querySelectorAll("script");let shopDomain="";scripts?.forEach(script=>{if(isValidHttpsUrl(script?.src)&&(new URL(script?.src)?.searchParams?.get("sd")||new URL(script?.src)?.searchParams?.get("shop"))){shopDomain=new URL(script?.src)?.searchParams.get("sd")??new URL(script?.src)?.searchParams.get("shop")}});return shopDomain}function addOrUpadateEventsInLocalStorage(eventPayload,eventType){let eventsArrayFromLocalstorage=localStorage.getItem("eventsArray");if(eventsArrayFromLocalstorage){eventsArrayFromLocalstorage=JSON.parse(eventsArrayFromLocalstorage);let event={eventPayload:eventPayload,eventType:eventType,timestamp:(new Date).getTime()};if(eventType=="login"){if(!eventsArrayFromLocalstorage.find(elem=>elem?.eventType=="login")){eventsArrayFromLocalstorage.push(event);localStorage.setItem("eventsArray",JSON.stringify(eventsArrayFromLocalstorage))}}else{eventsArrayFromLocalstorage.push(event);localStorage.setItem("eventsArray",JSON.stringify(eventsArrayFromLocalstorage))}}else{localStorage.setItem("eventsArray",JSON.stringify([{eventType:eventType,eventPayload:eventPayload,timestamp:(new Date).getTime()}]))}}function getBrowserAndOS(){const userAgent=window.navigator.userAgent;const platform=window.navigator.platform;let os="Unknown OS";let browser="Unknown Browser";if(platform.indexOf("Win")!==-1)os="Windows";else if(platform.indexOf("Mac")!==-1)os="MacOS";else if(platform.indexOf("Linux")!==-1)os="Linux";else if(/Android/.test(userAgent))os="Android";else if(/iPhone|iPad|iPod/.test(userAgent))os="iOS";if(userAgent.indexOf("Chrome")>-1)browser="Chrome";else if(userAgent.indexOf("Safari")>-1&&userAgent.indexOf("Chrome")===-1)browser="Safari";else if(userAgent.indexOf("Firefox")>-1)browser="Firefox";else if(userAgent.indexOf("MSIE")>-1||!!document.documentMode)browser="Internet Explorer";else if(userAgent.indexOf("Edge")>-1)browser="Edge";return{os:os,browser:browser}}function getDeviceType(){const ua=navigator.userAgent;if(/Mobile|Android|iP(ad|hone)/.test(ua)){return"Mobile"}else if(/Tablet|iPad/.test(ua)){return"Tablet"}else{return"Desktop"}}async function getVisitorInfo(){const{os,browser}=getBrowserAndOS();const deviceType=getDeviceType();return{os:os,browser:browser,deviceType:deviceType}}function handleLoginFormSubmit(form){let formData=serializeFormToJSON(form);let email=null;let name=null;let shopDomain=getShopDomain();Object.keys(formData).forEach(key=>{if(key?.includes("email")){email=formData[key]}if(key?.includes("name")){name=formData[key]}});if(email){let loginEvent={email:email,name:name,shopDomain:shopDomain};addOrUpadateEventsInLocalStorage(loginEvent,"login")}}function trackLoginAndRegisterFormSubmit(targetElem){try{let loginForm=null;if(targetElem.tagName=="FORM"){if(targetElem?.action?.includes("/login")||targetElem?.action?.includes("/register")||targetElem?.id?.includes("create")||targetElem?.id?.includes("login")){loginForm=targetElem}if(loginForm){handleLoginFormSubmit(loginForm)}addOrUpadateEventsInLocalStorage({actionUrl:targetElem?.action},"form-submit")}}catch(error){}}function trackButtonSubmit(){let loginForm=null;document?.querySelectorAll?.("button, input")?.forEach(button=>{if(button?.type?.includes("submit")){loginForm=button.closest("form")}});if(loginForm){handleLoginFormSubmit(loginForm)}}function trackInputSubmit(){let loginForm=null;document?.querySelectorAll?.("input")?.forEach(input=>{if(input?.value?.includes("login")||input?.value?.includes("create")){loginForm=input.closest("form")}});if(loginForm){handleLoginFormSubmit(loginForm)}}function trackUrlChange(){let currentUrl=window.location.href;let referrer=document.referrer;let visitorId=localStorage.getItem("visitor__id");let visitorSessionId=localStorage.getItem("visitorSessionId");let eventsFromLocalStorage=localStorage.getItem("eventsArray");let timespent=0;if(eventsFromLocalStorage){eventsFromLocalStorage=JSON.parse(eventsFromLocalStorage);let prevUrls=eventsFromLocalStorage.filter(event=>event.eventType=="url-change");if(prevUrls?.length>0){let prevUrl=prevUrls[prevUrls.length-1];timespent=((new Date).getTime()-prevUrl.timestamp)/1e3}}if(visitorId&&visitorSessionId){let urlEvent={currentUrl:currentUrl,referrer:referrer,timespent:timespent,title:document?.title??""};if(currentUrl?.includes("/products")){let img=document?.querySelectorAll("#main-content img, main img")[0];urlEvent.urlType="product";urlEvent.imgUrl=img?.getAttribute("src");addOrUpadateEventsInLocalStorage(urlEvent,"url-change")}else{addOrUpadateEventsInLocalStorage(urlEvent,"url-change")}}recordVisitCount(currentUrl);trackVisitorLoginStatus(referrer)}async function trackCart(){let lastCartTrackedTime=localStorage.getItem("lastCartTrackedTime");if(!lastCartTrackedTime||(new Date).getTime()-Number(lastCartTrackedTime)>=15*1e3){try{let response=await fetch(`${window.location.protocol}//${window.location.host}/cart.js`,{method:"GET"});response=await response.json();let encryptedCart=null;if(response?.items?.length>0){encryptedCart=btoa(JSON.stringify(response));let cartFromLocalStorage=localStorage.getItem("visitorCart");if(encryptedCart!=cartFromLocalStorage){let cartEvent={cartItems:response?.items?.map(item=>{return{url:item?.url,image:item?.image,quantity:item?.quantity,title:item?.title,price:item?.final_price/100,currency:response?.currency}})};addOrUpadateEventsInLocalStorage(cartEvent,"cart-update")}}localStorage.setItem("lastCartTrackedTime",(new Date).getTime());if(encryptedCart)localStorage.setItem("visitorCart",encryptedCart)}catch(error){}}}async function createSession(visitorId,shopDomain){let visitorLastActivityTime=localStorage.getItem("visitorLastActivityTime");if(!visitorLastActivityTime||(new Date).getTime()-Number(visitorLastActivityTime)>=15*60*1e3){localStorage.setItem("visitorLastActivityTime",(new Date).getTime());let visitorInfo=await getVisitorInfo();let sessionResponse=await fetch(`${BASE_URL}/api/storefront/visitors/session/create`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({visitorId:visitorId,shopDomain:shopDomain,startTime:(new Date).getTime(),deviceType:visitorInfo?.deviceType,os:visitorInfo?.os,browser:visitorInfo?.browser,returningUser:window?.logifyVisitorType})});sessionResponse=await sessionResponse.json();if(sessionResponse.status=="success"){localStorage.setItem("visitorSessionId",sessionResponse.data)}}}async function trackVisitorLoginStatus(prevUrl){if(prevUrl?.includes("account/login")||prevUrl?.includes("account/register")){let visitorInfo=document?.querySelector("script#web-pixels-manager-setup")?.innerHTML;let customer=visitorInfo?.split("customer")[1];let shopDomain=getShopDomain();if(customer?.includes("email")){let email=customer?.split('email":"')[1]?.split('"')[0];let loginEvent={email:email,shopDomain:shopDomain};addOrUpadateEventsInLocalStorage(loginEvent,"login")}}}async function createVisitor(visitorId,shopDomain){let visitorResponse=await fetch(`${BASE_URL}/api/storefront/visitors/create`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({visitorId:visitorId,shopDomain:shopDomain})});visitorResponse=await visitorResponse.json();if(visitorResponse.status=="success"){localStorage.setItem("visitor__id",visitorResponse?.data)}createSession(visitorResponse?.data,shopDomain)}async function updateVisitor(prevVisitorId,email,shopDomain){let visitorResponse=await fetch(`${BASE_URL}/api/storefront/visitors/${prevVisitorId}/update`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({shopDomain:shopDomain,email:email})});visitorResponse=await visitorResponse.json();if(visitorResponse.status=="success"){localStorage.setItem("visitor__id",prevVisitorId)}createSession(prevVisitorId,shopDomain)}function trackVisitor(){let visitorId=localStorage.getItem("visitor__id");if(!visitorId){let visitorInfo=document?.querySelector("script#web-pixels-manager-setup")?.innerHTML;let customer=visitorInfo?.split("customer")[1];let shopDomain=getShopDomain();window.logifyVisitorType=false;if(customer?.includes("email")){let email=customer?.split('email":"')[1]?.split('"')[0];createVisitor(email,shopDomain)}else{let tempVisitorId=crypto.randomUUID();createVisitor(tempVisitorId,shopDomain)}}else{let visitorInfo=document?.querySelector("script#web-pixels-manager-setup")?.innerHTML;let customer=visitorInfo?.split("customer")[1];let shopDomain=getShopDomain();window.logifyVisitorType=true;if(customer?.includes("email")){let email=customer?.split('email":"')[1]?.split('"')[0];updateVisitor(visitorId,email,shopDomain)}}}function trackButtonClicks(targetElem){if(targetElem.tagName=="BUTTON"){let eventPayload={text:targetElem.innerText,url:window.location.href};addOrUpadateEventsInLocalStorage(eventPayload,"button-click")}}function trackSearch(targetElem){let searchInput=null;if(targetElem.getAttribute("placeholder")?.match(RegExp(/search/,"i"))?.[0]){searchInput=targetElem}else if(targetElem?.name?.match(RegExp(/search/,"i"))?.[0]){searchInput=targetElem}else if(targetElem?.id?.match(RegExp(/search/,"i"))?.[0]){searchInput=targetElem}if(searchInput){let lastTypingTime=localStorage.getItem("lastTypingTime");let recordSearchPayload=false;if(!lastTypingTime){recordSearchPayload=true}else{if((new Date).getTime()-Number(lastTypingTime)>800){recordSearchPayload=true}}if(recordSearchPayload){let value=searchInput.value;if(value){let eventPayload={searchStr:value,currentUrl:window.location.href};addOrUpadateEventsInLocalStorage(eventPayload,"search-query");localStorage.setItem("lastTypingTime",(new Date).getTime())}}}}trackUrlChange();trackCart();trackVisitor();trackButtonSubmit();trackInputSubmit();function sleep(ms){return new Promise(resolve=>{setTimeout(()=>{resolve("Awake")},ms)})}function groupUrlsByTime(data){const now=Date.now();const oneHourTime=36e5;const oneDayTime=864e5;const threeDaysTime=2592e5;const oneHr=[];const oneDay=[];const threeDays=[];data.forEach(item=>{const timeDifference=now-item.time;if(timeDifference<=oneHourTime){oneHr.push(item.url)}else if(timeDifference<=oneDayTime){oneDay.push(item.url)}else if(timeDifference<=threeDaysTime){threeDays.push(item.url)}});return{oneHr:oneHr.length,oneDay:oneDay.length,threeDays:threeDays.length}}function syncEventsToDb(){let events=localStorage.getItem("eventsArray");let visitorActiveness=localStorage.getItem("visitorActiveness");let visits=localStorage.getItem("visits");if(events&&visitorActiveness){let visitorId=localStorage.getItem("visitor__id");let visitorSessionId=localStorage.getItem("visitorSessionId");visitorActiveness=JSON.parse(visitorActiveness);let duration=visitorActiveness.lastActiveAt-visitorActiveness.firstActiveAt;duration=duration/1e3;let date=(new Date).getTime();events=JSON.parse(events);visits=JSON.parse(visits);let groupedVisits=groupUrlsByTime(visits);fetch(`${BASE_URL}/api/storefront/visitors/events/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:events,visitorId:visitorId,sessionId:visitorSessionId,shopDomain:getShopDomain(),duration:duration,visits:groupedVisits,createdOn:date,localTimeObject:{hour:new Date(date).getHours(),month:new Date(date).getMonth(),day:new Date(date).getDay()}})});localStorage.removeItem("eventsArray")}}setInterval(()=>{syncEventsToDb()},5e3);function createNewVisitorSession(){let visitorIdFromLocal=localStorage.getItem("visitor__id");if(visitorIdFromLocal){createSession(visitorIdFromLocal,getShopDomain())}}function recordActiveness(){let visitorActiveness=localStorage.getItem("visitorActiveness");if(visitorActiveness){visitorActiveness=JSON.parse(visitorActiveness);let now=(new Date).getTime();if(now-visitorActiveness.firstActiveAt>10*60*1e3){visitorActiveness.firstActiveAt=now}visitorActiveness.lastActiveAt=now;localStorage.setItem("visitorActiveness",JSON.stringify(visitorActiveness))}else{visitorActiveness={firstActiveAt:(new Date).getTime(),lastActiveAt:(new Date).getTime()};localStorage.setItem("visitorActiveness",JSON.stringify(visitorActiveness))}}function recordVisitCount(url){let visits=localStorage.getItem("visits");if(visits){visits=JSON.parse(visits);let firstUrl=visits[0];if((new Date).getTime()-firstUrl.time>3*24*60*60*1e3){visits.splice(0,1)}visits.push({url:url,time:(new Date).getTime()});localStorage.setItem("visits",JSON.stringify(visits))}else{let urls=[{url:url,time:(new Date).getTime()}];localStorage.setItem("visits",JSON.stringify(urls))}}document.body.addEventListener("keypress",event=>{createNewVisitorSession();recordActiveness();trackSearch(event.target)});document.body.addEventListener("click",event=>{createNewVisitorSession();trackCart();recordActiveness();trackButtonClicks(event.target)});document.body.addEventListener("submit",event=>trackLoginAndRegisterFormSubmit(event.target));
