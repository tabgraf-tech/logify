const BASE_URL="https://logify-message-bus.tabgraf.com";const INTERACTION_TIMEOUT=10*60*1e3;function pad(n){return n<10?"0"+n:n}function uniqueArray(a){return[...new Set(a.map(o=>JSON.stringify(o)))].map(s=>JSON.parse(s))}function formatDate(inputDate,format){let date=new Date(inputDate).getDate();let month=new Date(inputDate).getMonth();let year=new Date(inputDate).getFullYear();format=format.replace("DD",pad(date)).replace(/\b(MM)\b/g,pad(month+1)).replace("YYYY",year);return format}function serializeFormToJSON(form){const formData=new FormData(form);const jsonObject={};formData.forEach((value,key)=>{if(jsonObject[key]){if(Array.isArray(jsonObject[key]))jsonObject[key].push(value);else jsonObject[key]=[jsonObject[key],value]}else{jsonObject[key]=value}});return jsonObject}function isValidHttpsUrl(string){try{const url=new URL(string);return url.protocol==="https:"}catch(_){return false}}function getShopDomain(){let scripts=document?.querySelectorAll("script");let shopDomain="";scripts?.forEach(script=>{if(isValidHttpsUrl(script?.src)&&(new URL(script?.src)?.searchParams?.get("sd")||new URL(script?.src)?.searchParams?.get("shop"))){shopDomain=new URL(script?.src)?.searchParams.get("sd")??new URL(script?.src)?.searchParams.get("shop")}});return shopDomain}function addOrUpadateEventsInLocalStorage(eventPayload,eventType){let eventsArrayFromLocalstorage=localStorage.getItem("eventsArray");if(eventsArrayFromLocalstorage){eventsArrayFromLocalstorage=JSON.parse(eventsArrayFromLocalstorage);let event={eventPayload:eventPayload,eventType:eventType,timestamp:(new Date).getTime()};if(eventType=="login"){if(!eventsArrayFromLocalstorage.find(elem=>elem?.eventType=="login")){eventsArrayFromLocalstorage.push(event);localStorage.setItem("eventsArray",JSON.stringify(eventsArrayFromLocalstorage))}}else{eventsArrayFromLocalstorage.push(event);localStorage.setItem("eventsArray",JSON.stringify(eventsArrayFromLocalstorage))}}else{localStorage.setItem("eventsArray",JSON.stringify([{eventType:eventType,eventPayload:eventPayload,timestamp:(new Date).getTime()}]))}}function getBrowserAndOS(){const userAgent=window.navigator.userAgent;const platform=window.navigator.platform;let os="Unknown OS";let browser="Unknown Browser";if(platform.indexOf("Win")!==-1)os="Windows";else if(platform.indexOf("Mac")!==-1)os="MacOS";else if(platform.indexOf("Linux")!==-1)os="Linux";else if(/Android/.test(userAgent))os="Android";else if(/iPhone|iPad|iPod/.test(userAgent))os="iOS";if(userAgent.indexOf("Chrome")>-1)browser="Chrome";else if(userAgent.indexOf("Safari")>-1&&userAgent.indexOf("Chrome")===-1)browser="Safari";else if(userAgent.indexOf("Firefox")>-1)browser="Firefox";else if(userAgent.indexOf("MSIE")>-1||!!document.documentMode)browser="Internet Explorer";else if(userAgent.indexOf("Edge")>-1)browser="Edge";return{os:os,browser:browser}}function getDeviceType(){const ua=navigator.userAgent;if(/Mobile|Android|iP(ad|hone)/.test(ua)){return"Mobile"}else if(/Tablet|iPad/.test(ua)){return"Tablet"}else{return"Desktop"}}async function getVisitorInfo(){const{os,browser}=getBrowserAndOS();const deviceType=getDeviceType();return{os:os,browser:browser,deviceType:deviceType}}function handleLoginFormSubmit(form){let formData=serializeFormToJSON(form);let email=null;let name=null;let shopDomain=getShopDomain();Object.keys(formData).forEach(key=>{if(key?.includes("email"))email=formData[key];if(key?.includes("name"))name=formData[key]});if(email){let loginEvent={email:email,name:name,shopDomain:shopDomain};addOrUpadateEventsInLocalStorage(loginEvent,"login")}}function trackLoginAndRegisterFormSubmit(targetElem){try{let loginForm=null;if(targetElem.tagName=="FORM"){if(targetElem?.action?.includes("/login")||targetElem?.action?.includes("/register")||targetElem?.id?.includes("create")||targetElem?.id?.includes("login")){loginForm=targetElem}if(loginForm){handleLoginFormSubmit(loginForm)}addOrUpadateEventsInLocalStorage({actionUrl:targetElem?.action},"form-submit")}}catch(error){}}function trackButtonSubmit(){let loginForm=null;document?.querySelectorAll?.("button, input")?.forEach(button=>{if(button?.type?.includes("submit")){loginForm=button.closest("form")}});if(loginForm){handleLoginFormSubmit(loginForm)}}function trackInputSubmit(){let loginForm=null;document?.querySelectorAll?.("input")?.forEach(input=>{if(input?.value?.includes("login")||input?.value?.includes("create")){loginForm=input.closest("form")}});if(loginForm){handleLoginFormSubmit(loginForm)}}const isValidImageUrl=src=>{if(!src)return false;if(src.startsWith("data:image/")||src.includes("transparent.png")||src.includes("spacer.gif")){return false}const path=src.split("?")[0];const hasImageExtension=/\.(jpg|jpeg|png|webp)$/i.test(path);if(!hasImageExtension)return false;return src.startsWith("http")||src.startsWith("//")};const cleanShopifyUrl=url=>{try{const parts=url.split("?");const baseUrl=parts[0];const query=parts.length>1?`?${parts.slice(1).join("?")}`:"";const lastDotIndex=baseUrl.lastIndexOf(".");if(lastDotIndex===-1)return url;const beforeExtension=baseUrl.substring(0,lastDotIndex);const extension=baseUrl.substring(lastDotIndex);const lastUnderscoreIndex=beforeExtension.lastIndexOf("_");if(lastUnderscoreIndex===-1)return url;const suffix=beforeExtension.substring(lastUnderscoreIndex);if(suffix.match(/_(\d+)x(\d+)?(@[2-3]x)?/)||suffix.match(/_(pico|icon|thumb|small|compact|medium|large|grande|original|master)/)){const cleanedBase=beforeExtension.substring(0,lastUnderscoreIndex);return cleanedBase+extension+query}return url}catch(e){return url}};function getShopifyMainImage(){const mainElements=document.querySelectorAll("#main-content, main, .content, div.index, #main");if(!mainElements||mainElements.length===0)return null;for(const mainElement of mainElements){const images=mainElement.querySelectorAll("img");if(!images||images.length===0)continue;for(const img of images){const w=img.clientWidth;const h=img.clientHeight;if(w===0||h===0||w<200)continue;const aspectRatio=w/h;const isBanner=aspectRatio>2.5||aspectRatio<.4;if(isBanner)continue;const sources=[img.currentSrc,img.dataset.src,img.getAttribute("data-src"),img.dataset.srcset?img.dataset.srcset.split(",")[0].trim().split(" ")[0]:null,img.getAttribute("data-srcset")?img.getAttribute("data-srcset").split(",")[0].trim().split(" ")[0]:null,img.srcset?img.srcset.split(",")[0].trim().split(" ")[0]:null,img.src];for(const src of sources){if(isValidImageUrl(src))return cleanShopifyUrl(src)}}}return null}function trackDailyVisit(){let visitDates=localStorage.getItem("visitDates");let today=formatDate(new Date,"DD-MM-YYYY");if(visitDates){visitDates=JSON.parse(visitDates);if(!visitDates.includes(today)){visitDates.push(today)}if(visitDates.length>180){visitDates.splice(0,1)}localStorage.setItem("visitDates",JSON.stringify(visitDates))}else{localStorage.setItem("visitDates",JSON.stringify([today]))}}function trackUrlChange(){let currentUrl=window.location.href;let referrer=document.referrer;let visitorId=localStorage.getItem("visitor__id");let visitorSessionId=localStorage.getItem("visitorSessionId");let prevUrl=sessionStorage.getItem("prevUrl");let currentTime=(new Date).getTime();let timespent=0;if(prevUrl){prevUrl=JSON.parse(prevUrl);timespent=(currentTime-prevUrl.timestamp)/1e3}sessionStorage.setItem("prevUrl",JSON.stringify({url:currentUrl,timestamp:currentTime}));if(visitorId&&visitorSessionId){let urlEvent={currentUrl:currentUrl,referrer:referrer,timespent:timespent,title:document?.title??"",imgUrl:getShopifyMainImage()};if(currentUrl?.includes("/products")){urlEvent.urlType="product";addOrUpadateEventsInLocalStorage(urlEvent,"url-change")}else addOrUpadateEventsInLocalStorage(urlEvent,"url-change")}recordVisitCount(currentUrl);trackVisitorLoginStatus(referrer)}async function trackCart(){let lastCartTrackedTime=localStorage.getItem("lastCartTrackedTime");if(!lastCartTrackedTime||(new Date).getTime()-Number(lastCartTrackedTime)>=15*1e3){try{let response=await fetch(`${window.location.protocol}//${window.location.host}/cart.js`,{method:"GET"});response=await response.json();let encryptedCart=null;if(response?.items?.length>0){encryptedCart=btoa(JSON.stringify(response));let cartFromLocalStorage=localStorage.getItem("visitorCart");if(encryptedCart!=cartFromLocalStorage){let cartEvent={cartItems:response?.items?.map(item=>{return{url:item?.url,image:item?.image,quantity:item?.quantity,title:item?.title,price:item?.final_price/100,currency:response?.currency}})};addOrUpadateEventsInLocalStorage(cartEvent,"cart-update")}}localStorage.setItem("lastCartTrackedTime",(new Date).getTime());if(encryptedCart)localStorage.setItem("visitorCart",encryptedCart)}catch(error){}}}function getVisitorEmail(){let scriptInnerContent=document?.querySelector("script#web-pixels-manager-setup")?.innerHTML;if(typeof scriptInnerContent!=="string"||!scriptInnerContent.trim()){return null}const emailRegex=/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;const match=scriptInnerContent.match(emailRegex);return match?match[0]:null}async function createSession(visitorId,shopDomain){let visitorLastActivityTime=localStorage.getItem("visitorLastActivityTime");if(!visitorLastActivityTime||(new Date).getTime()-Number(visitorLastActivityTime)>=15*60*1e3){localStorage.setItem("visitorLastActivityTime",(new Date).getTime());let visitorInfo=await getVisitorInfo();let sessionResponse=await fetch(`${BASE_URL}/api/storefront/visitors/session/create`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({visitorId:visitorId,shopDomain:shopDomain,startTime:(new Date).getTime(),deviceType:visitorInfo?.deviceType,os:visitorInfo?.os,browser:visitorInfo?.browser,returningUser:window?.logifyVisitorType})});sessionResponse=await sessionResponse.json();if(sessionResponse.status=="success"){localStorage.setItem("visitorSessionId",sessionResponse.data)}}}async function trackVisitorLoginStatus(prevUrl){if(prevUrl?.includes("account/login")||prevUrl?.includes("account/register")){let shopDomain=getShopDomain();let email=getVisitorEmail();if(email){let loginEvent={email:email,shopDomain:shopDomain};addOrUpadateEventsInLocalStorage(loginEvent,"login")}}}async function createVisitor(visitorId,shopDomain){let visitorResponse=await fetch(`${BASE_URL}/api/storefront/visitors/create`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({visitorId:visitorId,shopDomain:shopDomain})});visitorResponse=await visitorResponse.json();if(visitorResponse.status=="success"){localStorage.setItem("visitor__id",visitorResponse?.data)}createSession(visitorResponse?.data,shopDomain)}async function updateVisitor(prevVisitorId,email,shopDomain){let visitorResponse=await fetch(`${BASE_URL}/api/storefront/visitors/${prevVisitorId}/update`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({shopDomain:shopDomain,email:email})});visitorResponse=await visitorResponse.json();if(visitorResponse.status=="success"){localStorage.setItem("visitor__id",prevVisitorId)}createSession(prevVisitorId,shopDomain)}function trackVisitor(){let visitorId=localStorage.getItem("visitor__id");let email=getVisitorEmail();let shopDomain=getShopDomain();if(!visitorId){window.logifyVisitorType=false;if(email)createVisitor(email,shopDomain);else createVisitor(crypto.randomUUID(),shopDomain)}else{window.logifyVisitorType=true;if(email)updateVisitor(visitorId,email,shopDomain)}}function trackButtonClicks(targetElem){if(targetElem.tagName=="BUTTON"){let eventPayload={text:targetElem.innerText,url:window.location.href};addOrUpadateEventsInLocalStorage(eventPayload,"button-click")}}function trackSearch(targetElem){let searchInput=null;if(targetElem.getAttribute("placeholder")?.match(RegExp(/search/,"i"))?.[0]){searchInput=targetElem}else if(targetElem?.name?.match(RegExp(/search/,"i"))?.[0]){searchInput=targetElem}else if(targetElem?.id?.match(RegExp(/search/,"i"))?.[0]){searchInput=targetElem}if(searchInput){let lastTypingTime=localStorage.getItem("lastTypingTime");let recordSearchPayload=false;if(!lastTypingTime){recordSearchPayload=true}else{if((new Date).getTime()-Number(lastTypingTime)>800){recordSearchPayload=true}}if(recordSearchPayload){let value=searchInput.value;if(value){let eventPayload={searchStr:value,currentUrl:window.location.href};addOrUpadateEventsInLocalStorage(eventPayload,"search-query");localStorage.setItem("lastTypingTime",(new Date).getTime())}}}}function injectScripts(){let scripts=["https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"];scripts.forEach(script=>{let scriptElem=document.createElement("script");scriptElem.src=script;document.body.appendChild(scriptElem)})}function groupUrlsByTime(data){const now=Date.now();const oneHourTime=36e5;const oneDayTime=864e5;const threeDaysTime=2592e5;const oneHr=[];const oneDay=[];const threeDays=[];data.forEach(item=>{const timeDifference=now-item.time;if(timeDifference<=oneHourTime){oneHr.push(item.url)}else if(timeDifference<=oneDayTime){oneDay.push(item.url)}else if(timeDifference<=threeDaysTime){threeDays.push(item.url)}});return{oneHr:oneHr.length,oneDay:oneDay.length,threeDays:threeDays.length}}function sanitizeHTML(html){var tempDiv=document.createElement("div");tempDiv.innerHTML=html;var scripts=tempDiv.getElementsByTagName("script");while(scripts.length>0){scripts[0].parentNode.removeChild(scripts[0])}var allElements=tempDiv.getElementsByTagName("*");for(var i=0;i<allElements.length;i++){allElements[i].removeAttribute("onerror")}return tempDiv.innerHTML}function recordCampaignLog(logType,logDesc,campaignId){let visitorSessionId=localStorage.getItem("visitorSessionId");fetch(`${BASE_URL}/api/campaign/log/record`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shopDomain:getShopDomain(),sessionId:visitorSessionId,campaignId:campaignId,logType:logType,logDesc:logDesc})})}function shouldShowCampaingPopup(){let lastMTCtime=localStorage.getItem("lastMTCtime");if(lastMTCtime){if((new Date).getTime()-lastMTCtime>=15*1e3){localStorage.setItem("lastMTCtime",(new Date).getTime());return true}else{return false}}else{localStorage.setItem("lastMTCtime",(new Date).getTime());return true}}async function getVisitorCountry(){let countryRes=await fetch("https://geolocation-db.com/json/");countryRes=await countryRes.json();return countryRes?.country_name}function getProductsVisitCount(){let urlsVisited=localStorage.getItem("visits");if(urlsVisited){urlsVisited=JSON.parse(urlsVisited);urlsVisited=uniqueArray(urlsVisited.filter(url=>url.url?.toLowerCase()?.includes("/products/")).map(url=>url.url))?.length??0;return urlsVisited}else{return 0}}function getProductsInCart(){let cartFromLocalStorage=localStorage.getItem("visitorCart");if(cartFromLocalStorage){let cart=atob(cartFromLocalStorage);cart=JSON.parse(cart);return{count:cart?.item_count,products:cart?.items?.map(item=>item?.product_id)}}else{return{count:0,products:[]}}}function getActiveInactiveTime(){let visitorActiveness=localStorage.getItem("visitorActiveness");const{firstActiveAt,lastActiveAt}=JSON.parse(visitorActiveness);const now=Date.now();const activeDuration=Math.max(0,lastActiveAt-firstActiveAt);const timeSinceLastActivity=now-lastActiveAt;const isInactiveNow=timeSinceLastActivity>INTERACTION_TIMEOUT;const inactiveDuration=isInactiveNow?timeSinceLastActivity:0;return{activeSeconds:Math.round(activeDuration/1e3),inactiveSeconds:Math.round(inactiveDuration/1e3)}}function getWeekNumber(date){const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()));d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));const weekNo=Math.ceil(((d-yearStart)/864e5+1)/7);return weekNo}function groupVisitsByGranularity(dateStrings){const dailySet=new Set;const weeklySet=new Set;const monthlySet=new Set;dateStrings.forEach(dateStr=>{const[day,month,year]=dateStr.split("-").map(Number);const date=new Date(year,month-1,day);const dailyKey=date.toISOString().slice(0,10);dailySet.add(dailyKey);const weekYear=date.getFullYear();const weekNumber=getWeekNumber(date);const weeklyKey=`${weekYear}-W${weekNumber}`;weeklySet.add(weeklyKey);const monthlyKey=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}`;monthlySet.add(monthlyKey)});return{daily:dailySet.size,weekly:weeklySet.size,monthly:monthlySet.size}}function getFrequency(){let visitDates=localStorage.getItem("visitDates");if(visitDates){let frequency=groupVisitsByGranularity(JSON.parse(visitDates));return frequency}else{return null}}async function syncEventsToDb(){let events=localStorage.getItem("eventsArray");let visitorActiveness=localStorage.getItem("visitorActiveness");let visits=localStorage.getItem("visits");if(events&&visitorActiveness){let visitorId=localStorage.getItem("visitor__id");let visitorSessionId=localStorage.getItem("visitorSessionId");visitorActiveness=JSON.parse(visitorActiveness);let duration=visitorActiveness.lastActiveAt-visitorActiveness.firstActiveAt;duration=duration/1e3;let date=(new Date).getTime();let email=getVisitorEmail();events=JSON.parse(events);visits=JSON.parse(visits);let groupedVisits=groupUrlsByTime(visits);let response=await fetch(`${BASE_URL}/api/storefront/visitors/events/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:events,visitorId:visitorId,sessionId:visitorSessionId,shopDomain:getShopDomain(),duration:duration,visits:groupedVisits,createdOn:date,isLoggedIn:Boolean(email),localTimeObject:{hour:new Date(date).getHours(),month:new Date(date).getMonth(),day:new Date(date).getDay()},showCampaignPopup:true,visitorAttributes:{device:getDeviceType(),browser:getBrowserAndOS().browser,country:await getVisitorCountry(),loggedin:Boolean(email),returningType:window?.logifyVisitorType?"returning":"new",productsVisited:getProductsVisitCount(),productsInCart:getProductsInCart().count,productInCart:getProductsInCart().products,url:window.location.href,frequency:getFrequency(),time:(new Date).getHours(),inactiveTime:getActiveInactiveTime().inactiveSeconds,activeTime:getActiveInactiveTime().activeSeconds}})});response=await response.json();if(response.status=="success")if(response.campaign)showCampaign(response.campaign);localStorage.removeItem("eventsArray")}}setInterval(()=>{syncEventsToDb()},1e3);function createNewVisitorSession(){let visitorIdFromLocal=localStorage.getItem("visitor__id");if(visitorIdFromLocal){createSession(visitorIdFromLocal,getShopDomain())}}function recordActiveness(){let visitorActiveness=localStorage.getItem("visitorActiveness");if(visitorActiveness){visitorActiveness=JSON.parse(visitorActiveness);let now=(new Date).getTime();if(now-visitorActiveness.firstActiveAt>INTERACTION_TIMEOUT){visitorActiveness.firstActiveAt=now}visitorActiveness.lastActiveAt=now;localStorage.setItem("visitorActiveness",JSON.stringify(visitorActiveness))}else{visitorActiveness={firstActiveAt:(new Date).getTime(),lastActiveAt:(new Date).getTime()};localStorage.setItem("visitorActiveness",JSON.stringify(visitorActiveness))}}function recordVisitCount(url){let visits=localStorage.getItem("visits");if(visits){visits=JSON.parse(visits);let firstUrl=visits[0];if((new Date).getTime()-firstUrl.time>3*24*60*60*1e3){visits.splice(0,1)}visits.push({url:url,time:(new Date).getTime()});localStorage.setItem("visits",JSON.stringify(visits))}else{let urls=[{url:url,time:(new Date).getTime()}];localStorage.setItem("visits",JSON.stringify(urls))}}document.body.addEventListener("keypress",event=>{createNewVisitorSession();recordActiveness();trackSearch(event.target)});document.body.addEventListener("click",event=>{createNewVisitorSession();trackCart();recordActiveness();trackButtonClicks(event.target)});document.body.addEventListener("submit",event=>trackLoginAndRegisterFormSubmit(event.target));document.body.addEventListener("mouseover",event=>{let campaignPopup=document.querySelector(".logify-campaign-popup");if(campaignPopup){let mtctrackedId=localStorage.getItem("mtctrackedId");let campaignId=campaignPopup.getAttribute("id");if(mtctrackedId!=campaignId){recordCampaignLog("popup-viewed","popup-viewed",campaignId);localStorage.setItem("mtctrackedId",campaignId)}}});injectScripts();trackUrlChange();trackCart();trackVisitor();trackButtonSubmit();trackInputSubmit();trackDailyVisit();
