let BASE_URL="https://logify-message-bus.tabgraf.com",INTERACTION_TIMEOUT=6e5;function pad(e){return e<10?"0"+e:e}function base64EncodeUnicode(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(e,t)=>String.fromCharCode("0x"+t)))}function base64DecodeUnicode(e){return decodeURIComponent(atob(e).split("").map(e=>"%"+e.charCodeAt(0).toString(16).padStart(2,"0")).join(""))}function uniqueArray(e){return[...new Set(e.map(e=>JSON.stringify(e)))].map(e=>JSON.parse(e))}function formatDate(e,t){var i=new Date(e).getDate(),r=new Date(e).getMonth(),e=new Date(e).getFullYear();return t=t.replace("DD",pad(i)).replace(/\b(MM)\b/g,pad(r+1)).replace("YYYY",e)}function serializeFormToJSON(e){e=new FormData(e);let i={};return e.forEach((e,t)=>{i[t]?Array.isArray(i[t])?i[t].push(e):i[t]=[i[t],e]:i[t]=e}),i}function isValidHttpsUrl(e){try{return"https:"===new URL(e).protocol}catch(e){return!1}}function getShopDomain(){var e=document?.querySelectorAll("script");let t="";return e?.forEach(e=>{isValidHttpsUrl(e?.src)&&(new URL(e?.src)?.searchParams?.get("sd")||new URL(e?.src)?.searchParams?.get("shop"))&&(t=new URL(e?.src)?.searchParams.get("sd")??new URL(e?.src)?.searchParams.get("shop"))}),t}function addOrUpadateEventsInLocalStorage(e,t){var i,r=localStorage.getItem("eventsArray");r?(r=JSON.parse(r),i={eventPayload:e,eventType:t,timestamp:(new Date).getTime()},"login"==t&&r.find(e=>"login"==e?.eventType)||(r.push(i),localStorage.setItem("eventsArray",JSON.stringify(r)))):localStorage.setItem("eventsArray",JSON.stringify([{eventType:t,eventPayload:e,timestamp:(new Date).getTime()}]))}function getBrowserAndOS(){var e=window.navigator.userAgent,t=window.navigator.platform;let i="Unknown OS",r="Unknown Browser";return-1!==t.indexOf("Win")?i="Windows":-1!==t.indexOf("Mac")?i="MacOS":-1!==t.indexOf("Linux")?i="Linux":/Android/.test(e)?i="Android":/iPhone|iPad|iPod/.test(e)&&(i="iOS"),-1<e.indexOf("Chrome")?r="Chrome":-1<e.indexOf("Safari")&&-1===e.indexOf("Chrome")?r="Safari":-1<e.indexOf("Firefox")?r="Firefox":-1<e.indexOf("MSIE")||document.documentMode?r="Internet Explorer":-1<e.indexOf("Edge")&&(r="Edge"),{os:i,browser:r}}function getDeviceType(){var e=navigator.userAgent;return/Mobile|Android|iP(ad|hone)/.test(e)?"Mobile":/Tablet|iPad/.test(e)?"Tablet":"Desktop"}async function getVisitorInfo(){var{os:e,browser:t}=getBrowserAndOS();return{os:e,browser:t,deviceType:getDeviceType()}}function handleLoginFormSubmit(e){let t=serializeFormToJSON(e),i=null,r=null;e=getShopDomain();Object.keys(t).forEach(e=>{e?.includes("email")&&(i=t[e]),e?.includes("name")&&(r=t[e])}),i&&addOrUpadateEventsInLocalStorage({email:i,name:r,shopDomain:e},"login")}function trackLoginAndRegisterFormSubmit(t){try{let e=null;"FORM"==t.tagName&&((e=t?.action?.includes("/login")||t?.action?.includes("/register")||t?.id?.includes("create")||t?.id?.includes("login")?t:e)&&handleLoginFormSubmit(e),addOrUpadateEventsInLocalStorage({actionUrl:t?.action},"form-submit"))}catch(e){}}function trackButtonSubmit(){let t=null;document?.querySelectorAll?.("button, input")?.forEach(e=>{e?.type?.includes("submit")&&(t=e.closest("form"))}),t&&handleLoginFormSubmit(t)}function trackInputSubmit(){let t=null;document?.querySelectorAll?.("input")?.forEach(e=>{(e?.value?.includes("login")||e?.value?.includes("create"))&&(t=e.closest("form"))}),t&&handleLoginFormSubmit(t)}let isValidImageUrl=e=>{var t;return!!e&&!(e.startsWith("data:image/")||e.includes("transparent.png")||e.includes("spacer.gif")||(t=e.split("?")[0],!/\.(jpg|jpeg|png|webp)$/i.test(t)))&&(e.startsWith("http")||e.startsWith("//"))},cleanShopifyUrl=t=>{try{var e,i,r,a,n=t.split("?"),o=n[0],s=1<n.length?"?"+n.slice(1).join("?"):"",c=o.lastIndexOf(".");return-1===c?t:(e=o.substring(0,c),i=o.substring(c),-1!==(r=e.lastIndexOf("_"))&&((a=e.substring(r)).match(/_(\d+)x(\d+)?(@[2-3]x)?/)||a.match(/_(pico|icon|thumb|small|compact|medium|large|grande|original|master)/))?e.substring(0,r)+i+s:t)}catch(e){return t}};function getShopifyMainImage(){var e=document.querySelectorAll("#main-content, main, .content, div.index, #main");if(e&&0!==e.length)for(var t of e){t=t.querySelectorAll("img");if(t&&0!==t.length)for(var i of t){var r=i.clientWidth,a=i.clientHeight;if(!(0===r||0===a||r<200)){var n,r=r/a,a=2.5<r||r<.4;if(!a)for(n of[i.currentSrc,i.dataset.src,i.getAttribute("data-src"),i.dataset.srcset?i.dataset.srcset.split(",")[0].trim().split(" ")[0]:null,i.getAttribute("data-srcset")?i.getAttribute("data-srcset").split(",")[0].trim().split(" ")[0]:null,i.srcset?i.srcset.split(",")[0].trim().split(" ")[0]:null,i.src])if(isValidImageUrl(n))return cleanShopifyUrl(n)}}}return null}function trackDailyVisit(){var e=localStorage.getItem("visitDates"),t=formatDate(new Date,"DD-MM-YYYY");e?((e=JSON.parse(e)).includes(t)||e.push(t),180<e.length&&e.splice(0,1),localStorage.setItem("visitDates",JSON.stringify(e))):localStorage.setItem("visitDates",JSON.stringify([t]))}function trackUrlChange(){var e=window.location.href,t=document.referrer,i=localStorage.getItem("visitor__id"),r=localStorage.getItem("visitorSessionId"),a=sessionStorage.getItem("prevUrl"),n=(new Date).getTime();let o=0;a&&(a=JSON.parse(a),o=(n-a.timestamp)/1e3),sessionStorage.setItem("prevUrl",JSON.stringify({url:e,timestamp:n})),i&&r&&(a={currentUrl:e,referrer:t,timespent:o,title:document?.title??"",imgUrl:getShopifyMainImage()},e?.includes("/products")&&(a.urlType="product"),addOrUpadateEventsInLocalStorage(a,"url-change")),recordVisitCount(e),trackVisitorLoginStatus(t)}async function trackCart(){var i,e=localStorage.getItem("lastCartTrackedTime");if(!e||15e3<=(new Date).getTime()-Number(e))try{let t=await fetch(`${window.location.protocol}//${window.location.host}/cart.js`,{method:"GET"}),e=(t=await t.json(),null);0<t?.items?.length&&(e=base64EncodeUnicode(JSON.stringify(t)),i=localStorage.getItem("visitorCart"),e!=i)&&addOrUpadateEventsInLocalStorage({cartItems:t?.items?.map(e=>({url:e?.url,image:e?.image,quantity:e?.quantity,title:e?.title,price:e?.final_price/100,currency:t?.currency}))},"cart-update"),localStorage.setItem("lastCartTrackedTime",(new Date).getTime()),e&&localStorage.setItem("visitorCart",e)}catch(e){}}function getVisitorEmail(){var e=document?.querySelector("script#web-pixels-manager-setup")?.innerHTML;return"string"==typeof e&&e.trim()&&(e=e.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/))?e[0]:null}async function createSession(t,i){var r=localStorage.getItem("visitorLastActivityTime");if(!r||9e5<=(new Date).getTime()-Number(r)){localStorage.setItem("visitorLastActivityTime",(new Date).getTime());r=await getVisitorInfo();let e=await fetch(BASE_URL+"/api/storefront/visitors/session/create",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({visitorId:t,shopDomain:i,startTime:(new Date).getTime(),deviceType:r?.deviceType,os:r?.os,browser:r?.browser,returningUser:window?.logifyVisitorType})});"success"==(e=await e.json()).status&&localStorage.setItem("visitorSessionId",e.data)}}async function trackVisitorLoginStatus(e){var t;(e?.includes("account/login")||e?.includes("account/register"))&&(e=getShopDomain(),t=getVisitorEmail())&&addOrUpadateEventsInLocalStorage({email:t,shopDomain:e},"login")}async function createVisitor(e,t){let i=await fetch(BASE_URL+"/api/storefront/visitors/create",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({visitorId:e,shopDomain:t})});"success"==(i=await i.json()).status&&localStorage.setItem("visitor__id",i?.data),createSession(i?.data,t)}async function updateVisitor(e,t,i){let r=await fetch(BASE_URL+`/api/storefront/visitors/${e}/update`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({shopDomain:i,email:t})});"success"==(r=await r.json()).status&&localStorage.setItem("visitor__id",e),createSession(e,i)}function trackVisitor(){var e=localStorage.getItem("visitor__id"),t=getVisitorEmail(),i=getShopDomain();e?(window.logifyVisitorType=!0,t&&updateVisitor(e,t,i)):(window.logifyVisitorType=!1,createVisitor(t||crypto.randomUUID(),i))}function trackButtonClicks(e){"BUTTON"==e.tagName&&addOrUpadateEventsInLocalStorage({text:e.innerText,url:window.location.href},"button-click")}function trackSearch(t){if(!t)return null;var i=/search/i;let r=null;if(r="INPUT"===t.tagName&&("search"===t.type||i.test(t.placeholder||"")||i.test(t.name||"")||i.test(t.id||"")||i.test(t.getAttribute("aria-label")||"")||"searchbox"===t.getAttribute("role"))?t:r){i=localStorage.getItem("lastTypingTime");let e=!1;(e=!i||800<(new Date).getTime()-Number(i)?!0:e)&&(t=r.value)&&(addOrUpadateEventsInLocalStorage({searchStr:t,currentUrl:window.location.href},"search-query"),localStorage.setItem("lastTypingTime",(new Date).getTime()))}}function injectScripts(){["https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"].forEach(e=>{var t=document.createElement("script");t.src=e,document.body.appendChild(t)})}function groupUrlsByTime(e){let i=Date.now(),r=[],a=[],n=[];return e.forEach(e=>{var t=i-e.time;t<=36e5?r.push(e.url):t<=864e5?a.push(e.url):t<=2592e5&&n.push(e.url)}),{oneHr:r.length,oneDay:a.length,threeDays:n.length}}function sanitizeHTML(e){for(var t=document.createElement("div"),i=(t.innerHTML=e,t.getElementsByTagName("script"));0<i.length;)i[0].parentNode.removeChild(i[0]);for(var r=t.getElementsByTagName("*"),a=0;a<r.length;a++)r[a].removeAttribute("onerror");return t.innerHTML}function recordCampaignLog(e,t,i){var r=localStorage.getItem("visitorSessionId");fetch(BASE_URL+"/api/campaign/log/record",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shopDomain:getShopDomain(),sessionId:r,campaignId:i,logType:e,logDesc:t})})}function shouldShowCampaingPopup(){var e=localStorage.getItem("lastMTCtime");return(!e||15e3<=(new Date).getTime()-e)&&(localStorage.setItem("lastMTCtime",(new Date).getTime()),!0)}async function getVisitorCountry(){let e=await fetch("https://geolocation-db.com/json/");return(e=await e.json())?.country_name}function getProductsVisitCount(){let e=localStorage.getItem("visits");return e?e=uniqueArray((e=JSON.parse(e)).filter(e=>e.url?.toLowerCase()?.includes("/products/")).map(e=>e.url))?.length??0:0}function getProductsInCart(){var e=localStorage.getItem("visitorCart");return e?(e=base64DecodeUnicode(e),{count:(e=JSON.parse(e))?.item_count,products:e?.items?.map(e=>e?.product_id)}):{count:0,products:[]}}function getActiveInactiveTime(){var e=localStorage.getItem("visitorActiveness"),{firstActiveAt:e,lastActiveAt:t}=JSON.parse(e),i=Date.now(),e=Math.max(0,t-e),i=i-t,t=i>INTERACTION_TIMEOUT?i:0;return{activeSeconds:Math.round(e/1e3),inactiveSeconds:Math.round(t/1e3)}}function getWeekNumber(e){var e=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),t=(e.setUTCDate(e.getUTCDate()+4-(e.getUTCDay()||7)),new Date(Date.UTC(e.getUTCFullYear(),0,1)));return Math.ceil(((e-t)/864e5+1)/7)}function groupVisitsByGranularity(e){let r=new Set,a=new Set,n=new Set;return e.forEach(e=>{var[e,t,i]=e.split("-").map(Number),i=new Date(i,t-1,e),t=i.toISOString().slice(0,10),e=(r.add(t),i.getFullYear()),t=e+"-W"+getWeekNumber(i),e=(a.add(t),i.getFullYear()+"-"+String(i.getMonth()+1).padStart(2,"0"));n.add(e)}),{daily:r.size,weekly:a.size,monthly:n.size}}function getFrequency(){var e=localStorage.getItem("visitDates");return e?groupVisitsByGranularity(JSON.parse(e)):null}async function syncEventsToDb(){var t=localStorage.getItem("eventsArray"),i=localStorage.getItem("visitorActiveness"),r=localStorage.getItem("visits");if(t&&i){var a=localStorage.getItem("visitor__id"),n=localStorage.getItem("visitorSessionId"),i=(i=JSON.parse(i)).lastActiveAt-i.firstActiveAt,o=(i/=1e3,(new Date).getTime()),s=getVisitorEmail(),t=JSON.parse(t),r=groupUrlsByTime(JSON.parse(r));let e=await fetch(BASE_URL+"/api/storefront/visitors/events/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:t,visitorId:a,sessionId:n,shopDomain:getShopDomain(),duration:i,visits:r,createdOn:o,isLoggedIn:Boolean(s),localTimeObject:{hour:new Date(o).getHours(),month:new Date(o).getMonth(),day:new Date(o).getDay()},showCampaignPopup:!0,visitorAttributes:{device:getDeviceType(),browser:getBrowserAndOS().browser,country:await getVisitorCountry(),loggedin:Boolean(s),returningType:window?.logifyVisitorType?"returning":"new",productsVisited:getProductsVisitCount(),productsInCart:getProductsInCart().count,productInCart:getProductsInCart().products,url:window.location.href,frequency:getFrequency(),time:(new Date).getHours(),inactiveTime:getActiveInactiveTime().inactiveSeconds,activeTime:getActiveInactiveTime().activeSeconds}})});"success"==(e=await e.json()).status&&e.campaign&&showCampaign(e.campaign),localStorage.removeItem("eventsArray")}}function createNewVisitorSession(){var e=localStorage.getItem("visitor__id");e&&createSession(e,getShopDomain())}function recordActiveness(){let e=localStorage.getItem("visitorActiveness");var t;e?(e=JSON.parse(e),(t=(new Date).getTime())-e.firstActiveAt>INTERACTION_TIMEOUT&&(e.firstActiveAt=t),e.lastActiveAt=t):e={firstActiveAt:(new Date).getTime(),lastActiveAt:(new Date).getTime()},localStorage.setItem("visitorActiveness",JSON.stringify(e))}function recordVisitCount(e){var t,i=localStorage.getItem("visits");i?(t=(i=JSON.parse(i))[0],2592e5<(new Date).getTime()-t.time&&i.splice(0,1),i.push({url:e,time:(new Date).getTime()}),localStorage.setItem("visits",JSON.stringify(i))):(t=[{url:e,time:(new Date).getTime()}],localStorage.setItem("visits",JSON.stringify(t)))}setInterval(()=>{syncEventsToDb()},1e3),document.body.addEventListener("keypress",e=>{createNewVisitorSession(),recordActiveness(),trackSearch(e.target)}),document.body.addEventListener("click",e=>{createNewVisitorSession(),trackCart(),recordActiveness(),trackButtonClicks(e.target)}),document.body.addEventListener("submit",e=>trackLoginAndRegisterFormSubmit(e.target)),document.body.addEventListener("mouseover",e=>{var t=document.querySelector(".logify-campaign-popup");t&&localStorage.getItem("mtctrackedId")!=(t=t.getAttribute("id"))&&(recordCampaignLog("popup-viewed","popup-viewed",t),localStorage.setItem("mtctrackedId",t))}),injectScripts(),trackUrlChange(),trackCart(),trackVisitor(),trackButtonSubmit(),trackInputSubmit(),trackDailyVisit(); 
