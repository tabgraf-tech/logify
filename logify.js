let BASE_URL="https://logify-message-bus.tabgraf.com";function serializeFormToJSON(form){const formData=new FormData(form);const jsonObject={};formData.forEach((value,key)=>{if(jsonObject[key]){if(Array.isArray(jsonObject[key])){jsonObject[key].push(value)}else{jsonObject[key]=[jsonObject[key],value]}}else{jsonObject[key]=value}});return jsonObject}function isValidHttpsUrl(string){try{const url=new URL(string);return url.protocol==="https:"}catch(_){return false}}function getShopDomain(){let scripts=document?.querySelectorAll("script");let shopDomain="";scripts?.forEach(script=>{if(isValidHttpsUrl(script?.src)&&(new URL(script?.src)?.searchParams?.get("sd")||new URL(script?.src)?.searchParams?.get("shop"))){shopDomain=new URL(script?.src)?.searchParams.get("sd")??new URL(script?.src)?.searchParams.get("shop")}});return shopDomain}function addOrUpadateEventsInLocalStorage(eventPayload,eventType){let eventsArrayFromLocalstorage=localStorage.getItem("eventsArray");if(eventsArrayFromLocalstorage){eventsArrayFromLocalstorage=JSON.parse(eventsArrayFromLocalstorage);let event={eventPayload:eventPayload,eventType:eventType,timestamp:(new Date).getTime()};if(eventType=="login"){if(!eventsArrayFromLocalstorage.find(elem=>elem?.eventType=="login")){eventsArrayFromLocalstorage.push(event);localStorage.setItem("eventsArray",JSON.stringify(eventsArrayFromLocalstorage))}}else{eventsArrayFromLocalstorage.push(event);localStorage.setItem("eventsArray",JSON.stringify(eventsArrayFromLocalstorage))}}else{localStorage.setItem("eventsArray",JSON.stringify([{eventType:eventType,eventPayload:eventPayload,timestamp:(new Date).getTime()}]))}}function getBrowserAndOS(){const userAgent=window.navigator.userAgent;const platform=window.navigator.platform;let os="Unknown OS";let browser="Unknown Browser";if(platform.indexOf("Win")!==-1)os="Windows";else if(platform.indexOf("Mac")!==-1)os="MacOS";else if(platform.indexOf("Linux")!==-1)os="Linux";else if(/Android/.test(userAgent))os="Android";else if(/iPhone|iPad|iPod/.test(userAgent))os="iOS";if(userAgent.indexOf("Chrome")>-1)browser="Chrome";else if(userAgent.indexOf("Safari")>-1&&userAgent.indexOf("Chrome")===-1)browser="Safari";else if(userAgent.indexOf("Firefox")>-1)browser="Firefox";else if(userAgent.indexOf("MSIE")>-1||!!document.documentMode)browser="Internet Explorer";else if(userAgent.indexOf("Edge")>-1)browser="Edge";return{os:os,browser:browser}}function getDeviceType(){const ua=navigator.userAgent;if(/Mobile|Android|iP(ad|hone)/.test(ua)){return"Mobile"}else if(/Tablet|iPad/.test(ua)){return"Tablet"}else{return"Desktop"}}async function getVisitorInfo(){const{os,browser}=getBrowserAndOS();const deviceType=getDeviceType();return{os:os,browser:browser,deviceType:deviceType}}function handleLoginFormSubmit(form){let formData=serializeFormToJSON(form);let email=null;let name=null;let shopDomain=getShopDomain();Object.keys(formData).forEach(key=>{if(key?.includes("email")){email=formData[key]}if(key?.includes("name")){name=formData[key]}});if(email){let loginEvent={email:email,name:name,shopDomain:shopDomain};addOrUpadateEventsInLocalStorage(loginEvent,"login")}}function trackLoginAndRegisterFormSubmit(targetElem){try{let loginForm=null;if(targetElem.tagName=="FORM"){if(targetElem?.action?.includes("/login")||targetElem?.action?.includes("/register")||targetElem?.id?.includes("create")||targetElem?.id?.includes("login")){loginForm=targetElem}if(loginForm){handleLoginFormSubmit(loginForm)}addOrUpadateEventsInLocalStorage({actionUrl:targetElem?.action},"form-submit")}}catch(error){}}function trackButtonSubmit(){let loginForm=null;document?.querySelectorAll?.("button, input")?.forEach(button=>{if(button?.type?.includes("submit")){loginForm=button.closest("form")}});if(loginForm){handleLoginFormSubmit(loginForm)}}function trackInputSubmit(){let loginForm=null;document?.querySelectorAll?.("input")?.forEach(input=>{if(input?.value?.includes("login")||input?.value?.includes("create")){loginForm=input.closest("form")}});if(loginForm){handleLoginFormSubmit(loginForm)}}const isValidImageUrl=src=>{if(!src)return false;if(src.startsWith("data:image/")||src.includes("transparent.png")||src.includes("spacer.gif")){return false}const path=src.split("?")[0];const hasImageExtension=/\.(jpg|jpeg|png|webp)$/i.test(path);if(!hasImageExtension)return false;return src.startsWith("http")||src.startsWith("//")};const cleanShopifyUrl=url=>{try{const parts=url.split("?");const baseUrl=parts[0];const query=parts.length>1?`?${parts.slice(1).join("?")}`:"";const lastDotIndex=baseUrl.lastIndexOf(".");if(lastDotIndex===-1)return url;const beforeExtension=baseUrl.substring(0,lastDotIndex);const extension=baseUrl.substring(lastDotIndex);const lastUnderscoreIndex=beforeExtension.lastIndexOf("_");if(lastUnderscoreIndex===-1)return url;const suffix=beforeExtension.substring(lastUnderscoreIndex);if(suffix.match(/_(\d+)x(\d+)?(@[2-3]x)?/)||suffix.match(/_(pico|icon|thumb|small|compact|medium|large|grande|original|master)/)){const cleanedBase=beforeExtension.substring(0,lastUnderscoreIndex);return cleanedBase+extension+query}return url}catch(e){console.warn("Error cleaning Shopify URL:",e);return url}};function getShopifyMainImage(){const mainElements=document.querySelectorAll("#main-content, main, .content, div.index, #main");if(!mainElements||mainElements.length===0)return null;for(const mainElement of mainElements){const images=mainElement.querySelectorAll("img");if(!images||images.length===0)continue;for(const img of images){const w=img.clientWidth;const h=img.clientHeight;if(w===0||h===0||w<200)continue;const aspectRatio=w/h;const isBanner=aspectRatio>2.5||aspectRatio<.4;if(isBanner)continue;const sources=[img.currentSrc,img.dataset.src,img.getAttribute("data-src"),img.dataset.srcset?img.dataset.srcset.split(",")[0].trim().split(" ")[0]:null,img.getAttribute("data-srcset")?img.getAttribute("data-srcset").split(",")[0].trim().split(" ")[0]:null,img.srcset?img.srcset.split(",")[0].trim().split(" ")[0]:null,img.src];for(const src of sources){if(isValidImageUrl(src))return cleanShopifyUrl(src)}}}return null}function trackUrlChange(){let currentUrl=window.location.href;let referrer=document.referrer;let visitorId=localStorage.getItem("visitor__id");let visitorSessionId=localStorage.getItem("visitorSessionId");let prevUrl=sessionStorage.getItem("prevUrl");let currentTime=(new Date).getTime();let timespent=0;if(prevUrl){prevUrl=JSON.parse(prevUrl);timespent=(currentTime-prevUrl.timestamp)/1e3}sessionStorage.setItem("prevUrl",JSON.stringify({url:currentUrl,timestamp:currentTime}));if(visitorId&&visitorSessionId){let urlEvent={currentUrl:currentUrl,referrer:referrer,timespent:timespent,title:document?.title??"",imgUrl:getShopifyMainImage()};if(currentUrl?.includes("/products")){urlEvent.urlType="product";addOrUpadateEventsInLocalStorage(urlEvent,"url-change")}else addOrUpadateEventsInLocalStorage(urlEvent,"url-change")}recordVisitCount(currentUrl);trackVisitorLoginStatus(referrer)}async function trackCart(){let lastCartTrackedTime=localStorage.getItem("lastCartTrackedTime");if(!lastCartTrackedTime||(new Date).getTime()-Number(lastCartTrackedTime)>=15*1e3){try{let response=await fetch(`${window.location.protocol}//${window.location.host}/cart.js`,{method:"GET"});response=await response.json();let encryptedCart=null;if(response?.items?.length>0){encryptedCart=btoa(JSON.stringify(response));let cartFromLocalStorage=localStorage.getItem("visitorCart");if(encryptedCart!=cartFromLocalStorage){let cartEvent={cartItems:response?.items?.map(item=>{return{url:item?.url,image:item?.image,quantity:item?.quantity,title:item?.title,price:item?.final_price/100,currency:response?.currency}})};addOrUpadateEventsInLocalStorage(cartEvent,"cart-update")}}localStorage.setItem("lastCartTrackedTime",(new Date).getTime());if(encryptedCart)localStorage.setItem("visitorCart",encryptedCart)}catch(error){}}}async function createSession(visitorId,shopDomain){let visitorLastActivityTime=localStorage.getItem("visitorLastActivityTime");if(!visitorLastActivityTime||(new Date).getTime()-Number(visitorLastActivityTime)>=15*60*1e3){localStorage.setItem("visitorLastActivityTime",(new Date).getTime());let visitorInfo=await getVisitorInfo();let sessionResponse=await fetch(`${BASE_URL}/api/storefront/visitors/session/create`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({visitorId:visitorId,shopDomain:shopDomain,startTime:(new Date).getTime(),deviceType:visitorInfo?.deviceType,os:visitorInfo?.os,browser:visitorInfo?.browser,returningUser:window?.logifyVisitorType})});sessionResponse=await sessionResponse.json();if(sessionResponse.status=="success"){localStorage.setItem("visitorSessionId",sessionResponse.data)}}}async function trackVisitorLoginStatus(prevUrl){if(prevUrl?.includes("account/login")||prevUrl?.includes("account/register")){let visitorInfo=document?.querySelector("script#web-pixels-manager-setup")?.innerHTML;let customer=visitorInfo?.split("customer")[1];let shopDomain=getShopDomain();if(customer?.includes("email")){let email=customer?.split('email":"')[1]?.split('"')[0];let loginEvent={email:email,shopDomain:shopDomain};addOrUpadateEventsInLocalStorage(loginEvent,"login")}}}async function createVisitor(visitorId,shopDomain){let visitorResponse=await fetch(`${BASE_URL}/api/storefront/visitors/create`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({visitorId:visitorId,shopDomain:shopDomain})});visitorResponse=await visitorResponse.json();if(visitorResponse.status=="success"){localStorage.setItem("visitor__id",visitorResponse?.data)}createSession(visitorResponse?.data,shopDomain)}async function updateVisitor(prevVisitorId,email,shopDomain){let visitorResponse=await fetch(`${BASE_URL}/api/storefront/visitors/${prevVisitorId}/update`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({shopDomain:shopDomain,email:email})});visitorResponse=await visitorResponse.json();if(visitorResponse.status=="success"){localStorage.setItem("visitor__id",prevVisitorId)}createSession(prevVisitorId,shopDomain)}function trackVisitor(){let visitorId=localStorage.getItem("visitor__id");if(!visitorId){let visitorInfo=document?.querySelector("script#web-pixels-manager-setup")?.innerHTML;let customer=visitorInfo?.split("customer")[1];let shopDomain=getShopDomain();window.logifyVisitorType=false;if(customer?.includes("email")){let email=customer?.split('email":"')[1]?.split('"')[0];createVisitor(email,shopDomain)}else{let tempVisitorId=crypto.randomUUID();createVisitor(tempVisitorId,shopDomain)}}else{let visitorInfo=document?.querySelector("script#web-pixels-manager-setup")?.innerHTML;let customer=visitorInfo?.split("customer")[1];let shopDomain=getShopDomain();window.logifyVisitorType=true;if(customer?.includes("email")){let email=customer?.split('email":"')[1]?.split('"')[0];updateVisitor(visitorId,email,shopDomain)}}}function trackButtonClicks(targetElem){if(targetElem.tagName=="BUTTON"){let eventPayload={text:targetElem.innerText,url:window.location.href};addOrUpadateEventsInLocalStorage(eventPayload,"button-click")}}function trackSearch(targetElem){let searchInput=null;if(targetElem.getAttribute("placeholder")?.match(RegExp(/search/,"i"))?.[0]){searchInput=targetElem}else if(targetElem?.name?.match(RegExp(/search/,"i"))?.[0]){searchInput=targetElem}else if(targetElem?.id?.match(RegExp(/search/,"i"))?.[0]){searchInput=targetElem}if(searchInput){let lastTypingTime=localStorage.getItem("lastTypingTime");let recordSearchPayload=false;if(!lastTypingTime){recordSearchPayload=true}else{if((new Date).getTime()-Number(lastTypingTime)>800){recordSearchPayload=true}}if(recordSearchPayload){let value=searchInput.value;if(value){let eventPayload={searchStr:value,currentUrl:window.location.href};addOrUpadateEventsInLocalStorage(eventPayload,"search-query");localStorage.setItem("lastTypingTime",(new Date).getTime())}}}}function injectScripts(){let scripts=["https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"];scripts.forEach(script=>{let scriptElem=document.createElement("script");scriptElem.src=script;document.body.appendChild(scriptElem)})}injectScripts();trackUrlChange();trackCart();trackVisitor();trackButtonSubmit();trackInputSubmit();function sleep(ms){return new Promise(resolve=>{setTimeout(()=>{resolve("Awake")},ms)})}function groupUrlsByTime(data){const now=Date.now();const oneHourTime=36e5;const oneDayTime=864e5;const threeDaysTime=2592e5;const oneHr=[];const oneDay=[];const threeDays=[];data.forEach(item=>{const timeDifference=now-item.time;if(timeDifference<=oneHourTime){oneHr.push(item.url)}else if(timeDifference<=oneDayTime){oneDay.push(item.url)}else if(timeDifference<=threeDaysTime){threeDays.push(item.url)}});return{oneHr:oneHr.length,oneDay:oneDay.length,threeDays:threeDays.length}}function sanitizeHTML(html){var tempDiv=document.createElement("div");tempDiv.innerHTML=html;var scripts=tempDiv.getElementsByTagName("script");while(scripts.length>0){scripts[0].parentNode.removeChild(scripts[0])}var allElements=tempDiv.getElementsByTagName("*");for(var i=0;i<allElements.length;i++){allElements[i].removeAttribute("onerror")}return tempDiv.innerHTML}function recordCampaignLog(logType,logDesc,campaignId){let visitorSessionId=localStorage.getItem("visitorSessionId");fetch(`${BASE_URL}/api/campaign/log/record`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shopDomain:getShopDomain(),sessionId:visitorSessionId,campaignId:campaignId,logType:logType,logDesc:logDesc})})}function showNotificationContainerWithAnimation(position,notificationContainer){if(position=="bottom-left"){notificationContainer.style.bottom="-20%";notificationContainer.style.left="10px";setTimeout(()=>{notificationContainer.style.bottom="20px"},200)}if(position=="top-right"){notificationContainer.style.top="-20%";notificationContainer.style.right="10px";setTimeout(()=>{notificationContainer.style.top="20px"},200)}if(position=="top-left"){notificationContainer.style.top="-20%";notificationContainer.style.left="10px";setTimeout(()=>{notificationContainer.style.top="20px"},200)}if(position=="bottom-right"){notificationContainer.style.bottom="-20%";notificationContainer.style.right="10px";setTimeout(()=>{notificationContainer.style.bottom="20px"},200)}if(position=="zoom-center"){notificationContainer.style.top="50%";notificationContainer.style.left="50%";notificationContainer.style.transform="translate(-50%, -50%) scale(0%)";setTimeout(()=>{notificationContainer.style.transform="translate(-50%, -50%) scale(100%)"},200)}}function showCampaignPopup(campaign){if(!document.querySelector(".logify-campaign-popup")){let campaignContainer=document.createElement("div");campaignContainer.innerHTML=sanitizeHTML(campaign?.code);campaignContainer.classList.add("logify-campaign-popup",campaign?.popup_position??"");campaignContainer.setAttribute("style","background: white; position: fixed; z-index: 10000000000; transition: all 0.6s ease-out;");campaignContainer.setAttribute("id",campaign?.id);showNotificationContainerWithAnimation(campaign?.popup_position,campaignContainer);campaignContainer.innerHTML+=`<div class="campaign-close" style="position: absolute;top: 3px; right: 6px; font-size: 12px; cursor: pointer;">╳</div>`;document.body.appendChild(campaignContainer);campaignContainer.querySelector(".campaign-close").addEventListener("click",()=>{document.querySelector(".logify-campaign-popup").remove();recordCampaignLog("popup-closed","popup-closed",campaign?.id)});campaignContainer.querySelectorAll("button, a").forEach(elem=>{elem.addEventListener("click",()=>{recordCampaignLog("popup-interacted",`${elem.tagName} tag interacted`,campaign?.id)})});let couponCodeBtn=campaignContainer?.querySelector("#cpnBtn");if(couponCodeBtn){couponCodeBtn.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(campaignContainer?.querySelector("#cpnCode").innerText);couponCodeBtn.innerText="Copied"}catch(error){}})}}}function joinAnnouncement(campaign){let announcementModal=document.createElement("div");announcementModal.innerHTML=campaign?.type=="video"?sanitizeHTML(campaign.video_popup):sanitizeHTML(campaign.audio_popup);announcementModal.setAttribute("style","background: white; position: fixed; z-index: 10000000000; transition: all 0.6s ease-out;");announcementModal.innerHTML+=`<div class="announcement-close" style="position: absolute; top: 7px; right: 11px; font-size: 12px; cursor: pointer;">╳</div>`;showNotificationContainerWithAnimation("zoom-center",announcementModal);document.body.appendChild(announcementModal);if(campaign?.type=="video"){announcementModal.querySelector("#video-player").innerHTML+=`<video controls style="width: 100%;" src="${campaign?.url}"></video>`}else if(campaign?.type=="audio"){announcementModal.querySelector("#audio-player").innerHTML+=`<audio controls style="width: 100%;" src="${campaign?.url}"></audio>`}announcementModal.querySelector(".announcement-close").addEventListener("click",()=>announcementModal.remove())}function startAnnouncement(campaign){let notificationContainer=document.createElement("div");notificationContainer.innerHTML=sanitizeHTML(campaign.notification_popup);notificationContainer.classList.add("logify-campaign-annoucement");notificationContainer.setAttribute("style","background: white; position: fixed; z-index: 10000000000; transition: all 0.6s ease-out;");notificationContainer.innerHTML+=`<div class="campaign-close" style="position: absolute;top: 3px; right: 6px; font-size: 12px; cursor: pointer;">╳</div>`;notificationContainer.setAttribute("id",campaign?.id);showNotificationContainerWithAnimation(campaign.notification_popup_position,notificationContainer);document.body.appendChild(notificationContainer);notificationContainer.querySelector("#join-now").addEventListener("click",()=>{joinAnnouncement(campaign);document.querySelector(".logify-campaign-annoucement").remove()});notificationContainer.querySelector(".campaign-close").addEventListener("click",()=>document.querySelector(".logify-campaign-annoucement").remove())}function playNotificationSound(){let audio=null;if(!window.audio){audio=new Audio(`${BASE_URL}/sounds/notification.wav`);window.audio=audio}else{audio=window.audio}audio.play()}function showCampaign(campaign){if(localStorage.getItem("campaignId")!=campaign?.id){playNotificationSound();if(campaign?.type=="popup")showCampaignPopup(campaign);else startAnnouncement(campaign)}}function shouldShowCampaingPopup(){let lastMTCtime=localStorage.getItem("lastMTCtime");if(lastMTCtime){if((new Date).getTime()-lastMTCtime>=15*1e3){localStorage.setItem("lastMTCtime",(new Date).getTime());return true}else{return false}}else{localStorage.setItem("lastMTCtime",(new Date).getTime());return true}}async function syncEventsToDb(){let events=localStorage.getItem("eventsArray");let visitorActiveness=localStorage.getItem("visitorActiveness");let visits=localStorage.getItem("visits");if(events&&visitorActiveness){let visitorId=localStorage.getItem("visitor__id");let visitorSessionId=localStorage.getItem("visitorSessionId");visitorActiveness=JSON.parse(visitorActiveness);let duration=visitorActiveness.lastActiveAt-visitorActiveness.firstActiveAt;duration=duration/1e3;let date=(new Date).getTime();events=JSON.parse(events);visits=JSON.parse(visits);let groupedVisits=groupUrlsByTime(visits);let response=await fetch(`${BASE_URL}/api/storefront/visitors/events/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:events,visitorId:visitorId,sessionId:visitorSessionId,shopDomain:getShopDomain(),duration:duration,visits:groupedVisits,createdOn:date,localTimeObject:{hour:new Date(date).getHours(),month:new Date(date).getMonth(),day:new Date(date).getDay()}})});response=await response.json();localStorage.removeItem("eventsArray")}}setInterval(()=>{syncEventsToDb()},1e3);function createNewVisitorSession(){let visitorIdFromLocal=localStorage.getItem("visitor__id");if(visitorIdFromLocal){createSession(visitorIdFromLocal,getShopDomain())}}function recordActiveness(){let visitorActiveness=localStorage.getItem("visitorActiveness");if(visitorActiveness){visitorActiveness=JSON.parse(visitorActiveness);let now=(new Date).getTime();if(now-visitorActiveness.firstActiveAt>10*60*1e3){visitorActiveness.firstActiveAt=now}visitorActiveness.lastActiveAt=now;localStorage.setItem("visitorActiveness",JSON.stringify(visitorActiveness))}else{visitorActiveness={firstActiveAt:(new Date).getTime(),lastActiveAt:(new Date).getTime()};localStorage.setItem("visitorActiveness",JSON.stringify(visitorActiveness))}}function recordVisitCount(url){let visits=localStorage.getItem("visits");if(visits){visits=JSON.parse(visits);let firstUrl=visits[0];if((new Date).getTime()-firstUrl.time>3*24*60*60*1e3){visits.splice(0,1)}visits.push({url:url,time:(new Date).getTime()});localStorage.setItem("visits",JSON.stringify(visits))}else{let urls=[{url:url,time:(new Date).getTime()}];localStorage.setItem("visits",JSON.stringify(urls))}}document.body.addEventListener("keypress",event=>{createNewVisitorSession();recordActiveness();trackSearch(event.target)});document.body.addEventListener("click",event=>{createNewVisitorSession();trackCart();recordActiveness();trackButtonClicks(event.target)});document.body.addEventListener("submit",event=>trackLoginAndRegisterFormSubmit(event.target));
